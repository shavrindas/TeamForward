{% extends 'recommend/base.html' %}

{% block title %}
<html>
<head>
    <title>Recommendation</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            getLocation();
        });

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const situation = urlParams.get('situation');
            if (situation) {
                document.getElementById('selectedSituation').textContent = situation;
            }
        }

        function getLocation() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('latitude') && urlParams.has('longitude')) {
                return;
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }
        function showPosition(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            var currentPath = window.location.pathname;  // 현재 URL 경로
            var urlParams = new URLSearchParams(window.location.search);
            var situation = urlParams.get('situation');  // 현재 URL에서 situation 가져오기
            var weatherURL = currentPath + '?latitude=' + lat + '&longitude=' + lon;
            if (situation) {
                weatherURL += '&situation=' + situation;  // situation 추가
            }
            window.location.href = weatherURL;
        }
    
        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    console.log("User denied the request for Geolocation.");
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    console.log("Location information is unavailable.");
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    console.log("The request to get user location timed out.");
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    console.log("An unknown error occurred.");
                    alert("An unknown error occurred.");
                    break;
            }
        }

        function selectSituation(situation) {
            fetch('/recommend/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ situation: situation })
            }).then(() => {
                // 선택한 상황을 URL에 추가하고 페이지를 새로 고침
                
                document.getElementById('selectedSituation').textContent = situation;
                window.history.pushState({}, '', window.location.pathname + '?situation=' + situation);
                
                window.location.reload();
            });
        }

        function recommendButton(situation) {
            fetch('/recommend/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ recommend: situation})
            }).then(() => {
                window.location.reload();
            })
        }
    </script>    

</head>
<body>
    <h1>Recommendation</h1>
    <h5>Weather</h5>
    <div id = "recommend_argorithm">
        {% if weather %}
            <p>Temperature: {{ weather.main.temp }}°C</p>
            <p>Weather: {{ weather.weather.0.description }}</p>
        {% else %}
            <p>Loading...</p>
        {% endif %}
    </div>
    <h5>옷 입는 상황을 선택하세요:</h5>
    <button onclick="selectSituation('dandy')">Dandy</button>
    <button onclick="selectSituation('formal')">Formal</button>
    <button onclick="selectSituation('casual')">Casual</button>
    <button onclick="selectSituation('street')">Street</button>
    <button onclick="selectSituation('sporty')">Sporty</button>
    <p><span id="selectedSituation"></span>한 코디를 추천</p>
    <button onclick="recommendButton()">다시 추천 받기</button>
    <tr></tr>
    <h5>추천 코디</h5>
    <div id="selected_clothes">
        <div class="image-box">
            <p>bottom</p>
            {% if selected_bottom %}
                <img src="/media/user_pictures/{{ selected_bottom }}" alt="Selected bottom" class="selected-image">
            {% endif %}
        </div>
        <div class="image-box">
            <p>top</p>
            {% if selected_top %}
                <img src="/media/user_pictures/{{ selected_top }}" alt="Selected top" class="selected-image">
            {% endif %}
        </div>
        <div class="image-box">
            <p>outer</p>
            {% if selected_outer %}
                <img src="/media/user_pictures/{{ selected_outer }}" alt="Selected outer" class="selected-image">
            {% endif %}
    </div>
    
    <form id="recommendationForm" method="POST" action="{% url 'save_recommendation' %}">
        {% csrf_token %}
        <input type="hidden" name="top" value="{{ selected_top }}">
        <input type="hidden" name="bottom" value="{{ selected_bottom }}">
        <input type="hidden" name="outer" value="{{ selected_outer }}">
        <button type="button" onclick="saveRecommendation()">추천된 옷 저장</button>
    </form>
    
    <script>
        function saveRecommendation() {
            var form = document.getElementById('recommendationForm');
            var formData = new FormData(form);
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    // 저장이 성공하면 여기에 추가적인 동작을 할 수 있습니다.
                    console.log('추천된 옷이 성공적으로 저장되었습니다.');
                    window.alert('추천된 옷이 성공적으로 저장되었습니다.');
                } else {
                    console.error('추천된 옷을 저장하는 도중 오류가 발생했습니다.');
                    window.alert('추천된 옷을 저장하지 못했습니다.');
                }
            }).catch(error => {
                console.error('추천된 옷을 저장하는 도중 오류가 발생했습니다:', error);
                window.alert('추천된 옷을 저장하지 못했습니다.');
            });
        }
    </script>
</div>
</body>
</html>
{% endblock %}